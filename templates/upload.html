<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Upload Images - local-booru</title>
    <link rel="stylesheet" href="/static/css/styles.css">
</head>
<body>
    <div class="upload-form-container">
        <h1>Upload Images</h1>
        <form id="uploadForm" class="upload-form" action="/upload" method="post" enctype="multipart/form-data" autocomplete="off">
            <label for="file">Select image files:</label>
            <input type="file" name="files" id="file" multiple required>

            <div id="preview-container"></div>

            <label for="tagInput">Tags (comma-separated):</label>
            <div class="autocomplete-container">
                <input
                    type="text"
                    name="tags"
                    id="tagInput"
                    placeholder="e.g. cat, cute"
                    autocomplete="off"
                >
                <div class="suggestions"></div>
            </div>

            <button type="submit" id="upload-button" class="action-button">Upload</button>
        </form>

        <div id="upload-status"></div>
        <a href="/" class="action-button">Back to Home</a>
    </div>

    <script src="/static/js/autocomplete.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {

            // --- 1. DOM ELEMENT REFERENCES ---
            const uploadForm = document.getElementById('uploadForm');
            const fileInput = document.getElementById('file');
            const previewContainer = document.getElementById('preview-container');
            const tagInput = document.getElementById('tagInput');
            const suggestionsBox = document.querySelector('.suggestions');
            const uploadStatusDiv = document.getElementById('upload-status');
            const uploadButton = document.getElementById('upload-button');

            // --- 2. CORE FUNCTIONS ---

            /**
             * Handles the file input's 'change' event to display image previews.
             */
            function handleFileSelection() {
                previewContainer.innerHTML = '';
                const files = fileInput.files;
                if (!files) return;

                for (const file of files) {
                    if (file.type.startsWith('image/')) {
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            const img = document.createElement('img');
                            img.src = e.target.result;
                            img.className = 'preview-thumb';
                            previewContainer.appendChild(img);
                        };
                        reader.readAsDataURL(file);
                    }
                }
            }

            /**
             * Handles the form submission, uploads files, and provides user feedback.
             * @param {SubmitEvent} event - The form submission event.
             */
            async function handleFormSubmit(event) {
                event.preventDefault();
                
                // Provide immediate feedback that the upload has started.
                uploadStatusDiv.textContent = 'Uploading...';
                uploadStatusDiv.style.color = 'var(--color-text-primary)';
                uploadButton.disabled = true;
                uploadButton.textContent = 'Uploading...';

                try {
                    const formData = new FormData(uploadForm);
                    const response = await fetch('/upload', {
                        method: 'POST',
                        body: formData
                    });

                    if (response.ok) {
                        const result = await response.json();
                        uploadStatusDiv.textContent = result.message || 'Upload successful.';
                        uploadStatusDiv.style.color = 'var(--color-success)';
                        
                        // Reset the form for the next upload.
                        uploadForm.reset();
                        previewContainer.innerHTML = '';

                    } else {
                        // Handle server-side errors (e.g., validation).
                        let errorText = 'Upload failed: An unknown error occurred.';
                        try {
                            const error = await response.json();
                            errorText = `Upload failed: ${error.detail || error.message}`;
                        } catch {
                            errorText = `Upload failed: Server responded with status ${response.status}.`;
                        }
                        uploadStatusDiv.textContent = errorText;
                        uploadStatusDiv.style.color = 'var(--color-danger)';
                    }
                } catch (error) {
                    // Handle network errors.
                    console.error('Error during upload:', error);
                    uploadStatusDiv.textContent = 'An unexpected network error occurred.';
                    uploadStatusDiv.style.color = 'var(--color-danger)';
                } finally {
                    // Always re-enable the upload button.
                    uploadButton.disabled = false;
                    uploadButton.textContent = 'Upload';
                }
            }
            
            // --- 3. INITIALIZATION ---

            /**
             * Sets up the page by initializing autocomplete and attaching event listeners.
             */
            function initialize() {
                // Set up autocomplete for the tag input field.
                // Saved searches are intentionally disabled on this page.
                setupTagAutocomplete(tagInput, suggestionsBox);
                
                // Attach the event handlers.
                fileInput.addEventListener('change', handleFileSelection);
                uploadForm.addEventListener('submit', handleFormSubmit);
            }

            // --- 4. START THE APPLICATION ---
            initialize();
        });
    </script>
</body>
</html>