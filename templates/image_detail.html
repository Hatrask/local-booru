<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Edit Image {{ image.id }} - local-booru</title>
    <link rel="stylesheet" href="/static/css/styles.css">
</head>
<body>
    <div class="detail-page-container">
	    <h1>Edit Image #{{ image.id }}</h1>
        <form class="edit-form" action="/retag/{{ image.id }}" method="post" autocomplete="off">
            <label for="tags">Tags:</label>
            <div class="autocomplete-container">
                <textarea
                    name="tags"
                    id="tags"
                    placeholder="e.g. cat, cute, sunset"
                >{{ tags_str }}</textarea>
                <div class="suggestions"></div>
            </div>

            <div class="form-actions">
                <a href="javascript:history.back()" class="action-button back-button">Back</a>
                <button type="submit" class="action-button save-button">Save Tags</button>
            </div>
        </form>

        <img src="/media/images/{{ image.filename }}" alt="Image {{ image.id }}" class="detail-image">
    </div>

    <script src="/static/js/autocomplete.js"></script>
	<script src="/static/js/notifications.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {

            // --- 1. DOM ELEMENT REFERENCES ---
            const tagInput = document.getElementById('tags');
            const suggestionsBox = document.querySelector('.suggestions');
            const editForm = document.querySelector('.edit-form');


            // --- 2. EVENT HANDLERS ---

            /**
             * Handles the form submission for editing tags.
             * Submits the data asynchronously and shows a toast notification on completion.
             * @param {Event} event - The form submission event.
             */
            async function handleFormSubmit(event) {
                event.preventDefault(); // Prevent default page reload

                const formData = new FormData(editForm);
                const url = editForm.action;

                try {
                    const response = await fetch(url, {
                        method: 'POST',
                        body: new URLSearchParams(formData)
                    });

                    if (response.ok) {
                        showToast('Tags saved successfully!', 'success');
                    } else {
                        console.error('Failed to save tags:', response.status, response.statusText);
                        showToast(`Error: Could not save tags (server error).`, 'error');
                    }
                } catch (error) {
                    console.error('Form submission failed:', error);
                    showToast('Error: Could not save tags (network error).', 'error');
                }
            }


            // --- 3. INITIALIZATION ---

            /**
             * Sets up the page by initializing the tag autocomplete and form handler.
             */
            function initialize() {
                // Set up autocomplete for the tag input field.
                setupTagAutocomplete(tagInput, suggestionsBox);

                // Attach the async submit handler to the form.
                if (editForm) {
                    editForm.addEventListener('submit', handleFormSubmit);
                }
            }

            // --- 4. START THE APPLICATION ---
            initialize();
        });
    </script>
</body>
</html>